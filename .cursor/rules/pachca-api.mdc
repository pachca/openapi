---
description: Pachca API — корпоративный мессенджер
globs: "**/*"
---

# Pachca API

Base URL: `https://api.pachca.com/api/shared/v1`
Авторизация: `Authorization: Bearer <ACCESS_TOKEN>`

## Скиллы

### Профиль и статус (pachca-profile)

Получение и обновление профиля текущего пользователя, управление статусом, кастомные поля сотрудников. Используй когда нужно: получить свой профиль, обновить статус, узнать дополнительные поля.

### Сотрудники и теги (pachca-users)

Управление сотрудниками и тегами (группами). Создание, обновление, удаление, поиск сотрудников.

**Массовое создание сотрудников с тегами:**
1. Создай тег (если нужен): POST /group_tags с { group_tag: { name } }
2. Для каждого сотрудника: POST /users — теги назначаются через поле list_tags в теле запроса
3. Или обнови существующего: PUT /users/{id} с list_tags
> Создание сотрудников доступно только администраторам и владельцам (не ботам). Нет отдельного эндпоинта "добавить юзера в тег" — теги назначаются через list_tags в POST/PUT /users.

### Чаты и участники (pachca-chats)

Управление каналами и беседами, участниками чатов. Создание, обновление, архивация чатов.

**Создать канал и пригласить участников:**
1. POST /chats — channel: true для канала, false (по умолчанию) для беседы
2. Участников можно передать сразу при создании: member_ids и/или group_tag_ids в теле запроса
3. Или добавить позже: POST /chats/{id}/members с member_ids, POST /chats/{id}/group_tags с group_tag_ids
> channel — boolean, не строка. member_ids и group_tag_ids — опциональны при создании.

**Архивация и управление чатом:**
1. Архивировать: PUT /chats/{id}/archive
2. Разархивировать: PUT /chats/{id}/unarchive
3. Изменить роль участника: PUT /chats/{chatId}/members/{userId} с role (admin|editor|member)
4. Удалить участника: DELETE /chats/{chatId}/members/{userId}
5. Покинуть чат: DELETE /chats/{id}/leave

### Сообщения (pachca-messages)

Отправка сообщений в каналы, беседы и личные чаты Пачки. Ответы в треды, загрузка файлов, кнопки, реакции, закрепление, прочтения.

**Найти чат по имени и отправить сообщение:**
1. GET /chats — перебери результаты, найди нужный по полю name
2. Отправь POST /messages с entity_id: chat.id
> entity_type по умолчанию "discussion", можно не указывать. GET /chats не поддерживает поиск по имени — перебирай страницы.

**Отправить сообщение в канал или беседу (если chat_id известен):**
1. Отправь POST /messages с entity_id: chat_id
> entity_type: "discussion" используется по умолчанию, можно не указывать

**Отправить личное сообщение пользователю:**
1. Определи user_id получателя (GET /users или из контекста)
2. Отправь POST /messages с entity_type: "user", entity_id: user_id
> Создавать чат НЕ требуется — он создаётся автоматически

### Боты и Webhook (pachca-bots)

Управление ботами, входящие/исходящие вебхуки, разворачивание ссылок (unfurling). Используй когда нужно: настроить бота, обработать вебхук, проверить подпись вебхука, развернуть ссылку.

**Настроить бота с исходящим вебхуком:**
1. Создай бота в интерфейсе Пачки: Автоматизации → Интеграции → Webhook
2. Получи access_token бота во вкладке «API» настроек бота
3. Укажи Webhook URL для получения событий
4. Выбери типы событий: новые сообщения, реакции, кнопки, участники
> Бот создаётся через UI, не через API. Единственный эндпоинт для ботов — PUT /bots/{id} (обновление webhook URL). API используется для отправки сообщений от имени бота.

**Обработать входящий вебхук-событие:**
1. Получи POST-запрос на свой Webhook URL
2. Проверь подпись (Signing secret) для безопасности
3. Проверь webhook_timestamp — должен быть в пределах 1 минуты
4. Разбери JSON: тип события, данные
5. Для полной информации сделай запрос к API (например, GET /messages/{id})
> Вебхук содержит минимум данных. Для полной информации используй API.

**Разворачивание ссылок (unfurling):**
1. Создай специального Unfurl-бота и укажи отслеживаемые домены в его настройках
2. При появлении ссылки бот получает вебхук event: "link_shared" с массивом links (url + domain) и message_id
3. Извлеки данные из своей системы по URL из links
4. Отправь POST /messages/{message_id}/link_previews с превью-данными
> Эндпоинт привязан к конкретному сообщению. Необходим специальный Unfurl-бот с указанными доменами.

### Интерактивные формы (pachca-forms)

Интерактивные формы с полями ввода и кнопками для ботов. Используй когда нужно: показать форму, обработать submit формы, создать модальное окно.

**Показать интерактивную форму пользователю:**
1. Заранее подготовь объект формы (view с title и blocks) — собери его ДО получения trigger_id
2. Отправь сообщение с кнопкой (POST /messages с buttons, в data кнопки передай идентификатор формы)
3. При нажатии кнопки — получи вебхук-событие с trigger_id
4. Немедленно отправь POST /views/open с trigger_id и готовым объектом формы
5. Пользователь заполняет форму → результат приходит на Webhook URL
> trigger_id живёт 3 секунды — за это время нужно успеть отправить POST /views/open. Формируй объект формы заранее, а не после получения события. Формы работают только от бота (GET /profile → data.bot === true).

### Напоминания (pachca-tasks)

Создание, получение, обновление и удаление задач (напоминаний). Используй когда нужно: создать задачу, получить список задач, обновить задачу, удалить задачу.

### Безопасность (pachca-security)

Журнал аудита событий и DLP-система. Используй когда нужно: получить журнал аудита, просмотреть события безопасности, настроить DLP.

**Получить журнал аудита событий:**
1. GET /audit_events с фильтрами (event_key, период, пагинация)
2. Доступные типы событий: входы, изменения прав, действия с чатами и т.д.
> Доступно только владельцу пространства.

## Ошибки

| Код | Что делать |
|-----|-----------|
| 422 | Проверь обязательные поля и допустимые значения |
| 429 | Rate limit — подожди и повтори |
| 403 | Нет доступа — проверь права токена |
| 404 | Сущность не найдена — проверь id |
