name: Build & Deploy site

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-site:
    name: Build & push image
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitLab registry
        uses: docker/login-action@v3
        with:
          registry: registry.primaverahq.com
          username: ${{ secrets.GITLAB_REGISTRY_USER }}
          password: ${{ secrets.GITLAB_REGISTRY_PASSWORD }}

      - name: Build & push site image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            registry.primaverahq.com/mp/docs:${{ github.sha }}
            registry.primaverahq.com/mp/docs:latest

  deploy-site:
    name: Deploy site on server
    runs-on: self-hosted
    needs: build-site
    steps:
      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf "Host *\n  StrictHostKeyChecking no\n" > ~/.ssh/config

      - name: Deploy site via SSH
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          REG_USER: ${{ secrets.GITLAB_REGISTRY_USER }}
          REG_PASS: ${{ secrets.GITLAB_REGISTRY_PASSWORD }}
        run: |
          ssh "$DEPLOY_USER@$DEPLOY_HOST" "
            set -e
            cd /var/www/docs
            docker login -u '$REG_USER' -p '$REG_PASS' registry.primaverahq.com
            docker compose pull docs
            docker compose up -d docs
          "
