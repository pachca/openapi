
# Ошибки и лимиты

## Коды

Мы используем обычные коды ответов `HTTP` для обозначения результата выполнения запроса.

Коды группы `2**` указывают на успех. Коды группы `3**` указывают на перенаправление (например, при скачивании файла). Коды группы `4**` указывают на ошибку запроса, который не удался с учетом предоставленной информации (например, обязательный параметр был пропущен, несуществующий идентификатор и др.). Коды группы `5**` указывают на ошибки на серверах Пачки (они редки).

### Коды ответов HTTP

| Код | Сообщение | Описание |
|-----|-----------|----------|
| 200 | OK | Запрос отработал как положено, без ошибок |
| 201 | Created | Запрос отработал успешно, сущность создана |
| 204 | No Content | Запрос отработал успешно, тело ответа отсутствует (например, при удалении ресурса) |
| 301 | Moved Permanently | Запрошенный ресурс был на постоянной основе перемещён в новое месторасположение (такой ответ вы можете получить если выполните запрос по протоколу HTTP, а не по HTTPS) |
| 302 | Found | Перенаправление на другой URL (например, при скачивании файла экспорта — в заголовке Location будет временная ссылка на файл) |
| 400 | Bad Request | Неприемлемый запрос (часто из-за отсутствия обязательного параметра) |
| 401 | Unauthorized | Предоставлен недействительный токен доступа |
| 402 | Payment Required | Параметры действительны, но запрос не выполнен |
| 403 | Forbidden | Предоставленный токен доступа не имеет разрешений на выполнение запроса |
| 404 | Not Found | Запрашиваемый ресурс не существует |
| 409 | Conflict | Запрос конфликтует с другим запросом (возможно, из-за использования того же идемпотентного ключа) |
| 410 | Gone | Ресурс больше не доступен (например, истёк срок действия идентификатора события) |
| 422 | Unprocessable Entity | С запросом все хорошо, но правила сервиса не позволяют его обработать (например, при попытке создания контакта с уже существующим номером телефона в базе) |
| 429 | Too Many Requests | Слишком много запросов слишком быстро попадают в API |
| 500, 502, 503, 504 | Server Errors | Что-то пошло не так на сервере Пачки (это редкость) |


## Пояснения ошибки

В зависимости от типа ошибки вы получите в теле ответа одну из следующих структур:

- **ApiError** — для кодов `400`, `403`, `404`, `409`, `410`, `422`. Содержит массив `errors` с детальной информацией об ошибках.
- **OAuthError** — для кодов `401` и `403`. Содержит поля `error` и `error_description` с информацией об ошибке авторизации.

> Код `403` может вернуть обе структуры:
>
> - `OAuthError` с кодом `insufficient_scope`, когда у токена нет нужного скоупа (scope) для вызываемого метода.
> - `ApiError`, когда бизнес-логика запрещает действие (например, недостаточно прав для управления экспортом).

### ApiError (400, 403, 404, 409, 410, 422)

- `errors` (array[object], **обязательный**): Массив ошибок
  - `key` (string, **обязательный**): Ключ поля с ошибкой
    - Пример: `field.name`
  - `value` (string, **обязательный**): Значение поля, которое вызвало ошибку
    - Пример: `invalid_value`
  - `message` (string, **обязательный**): Сообщение об ошибке
    - Пример: `Поле не может быть пустым`
  - `code` (string, **обязательный**): Код ошибки
    - **Возможные значения:**
      - `blank`: Обязательное поле (не может быть пустым)
      - `too_long`: Слишком длинное значение (пояснения вы получите в поле message)
      - `invalid`: Поле не соответствует правилам (пояснения вы получите в поле message)
      - `inclusion`: Поле имеет непредусмотренное значение
      - `exclusion`: Поле имеет недопустимое значение
      - `taken`: Название для этого поля уже существует
      - `wrong_emoji`: Emoji статуса не может содержать значения отличные от Emoji символа
      - `not_found`: Объект не найден
      - `already_exists`: Объект уже существует (пояснения вы получите в поле message)
      - `personal_chat`: Ошибка личного чата (пояснения вы получите в поле message)
      - `displayed_error`: Отображаемая ошибка (пояснения вы получите в поле message)
      - `not_authorized`: Действие запрещено
      - `invalid_date_range`: Выбран слишком большой диапазон дат
      - `invalid_webhook_url`: Некорректный URL вебхука
      - `rate_limit`: Достигнут лимит запросов
      - `licenses_limit`: Превышен лимит активных сотрудников (пояснения вы получите в поле message)
      - `user_limit`: Превышен лимит количества реакций, которые может добавить пользователь (20 уникальных реакций)
      - `unique_limit`: Превышен лимит количества уникальных реакций, которые можно добавить на сообщение (30 уникальных реакций)
      - `general_limit`: Превышен лимит количества реакций, которые можно добавить на сообщение (1000 реакций)
      - `unhandled`: Ошибка выполнения запроса (пояснения вы получите в поле message)
      - `trigger_not_found`: Не удалось найти идентификатор события
      - `trigger_expired`: Время жизни идентификатора события истекло
      - `required`: Обязательный параметр не передан
      - `in`: Недопустимое значение (не входит в список допустимых)
      - `not_applicable`: Значение неприменимо в данном контексте (пояснения вы получите в поле message)
      - `self_update`: Нельзя изменить свои собственные данные
      - `owner_protected`: Нельзя изменить данные владельца
      - `already_assigned`: Значение уже назначено
      - `forbidden`: Недостаточно прав для выполнения действия (пояснения вы получите в поле message)
      - `permission_denied`: Доступ запрещён (недостаточно прав)
      - `access_denied`: Доступ запрещён
      - `wrong_params`: Некорректные параметры запроса (пояснения вы получите в поле message)
      - `payment_required`: Требуется оплата
      - `min_length`: Значение слишком короткое (пояснения вы получите в поле message)
      - `max_length`: Значение слишком длинное (пояснения вы получите в поле message)
  - `payload` (string, **обязательный**): Дополнительные данные об ошибке
    - Пример: `null`

### OAuthError (401, 403)

- `error` (string, **обязательный**): Код ошибки
  - Пример: `invalid_token`
- `error_description` (string, **обязательный**): Описание ошибки
  - Пример: `Access token is missing`


## Лимиты

Мы следим за стабильностью API, поэтому есть лимиты на запросы (rate limiting). Они гибкие, зависят от нагрузки, но мы сделали их комфортными — должно хватить для любых ваших задач.

<Limit
  title="Входящие вебхуки"
  limit="~4 запроса"
  period="1 секунда"
  howItWorks="Лимит привязан к идентификатору вебхука в пути. <div class='text-text-secondary'>Например, для <code class='text-text-secondary!'>&#47;webhooks/user123</code> считаем по <code class='text-text-secondary!'>user123</code></div>"
/>

Если за секунду отправите больше 2 запросов на один идентификатор, лишние получат `429 Too Many Requests`. В заголовке `Retry-After` мы укажем, через сколько секунд можно попробовать снова.

### API

<Limit
  title="Отправка, изменение и удаление сообщений"
  limit="~4 запроса"
  period="1 секунда"
  entity="chat_id"
  howItWorks="Считаем по токену авторизации (заголовок <code>HTTP_AUTHORIZATION</code>). Один токен — один лимит. <span class='text-text-secondary'>Запросы учитываются по каждому чату отдельно. Дополнительно, допускаются короткие ускорения выше указанного лимита отправки сообщений: до 30 запросов в секунду на протяжении 5 секунд в каждый чат.</span>"
/>

<Limit
  title="Получение сообщений"
  limit="~10 запросов"
  period="1 секунда"
  howItWorks="Считаем по токену авторизации (заголовок <code>HTTP_AUTHORIZATION</code>). Один токен — один лимит."
/>

<Limit
  title="Остальные методы API"
  limit="~50 запросов"
  period="1 секунда"
  howItWorks="Считаем по токену авторизации (заголовок <code>HTTP_AUTHORIZATION</code>). Один токен — один лимит."
/>

Если за секунду будет больше указанных запросов с одним токеном, API вернёт `429 Too Many Requests`. В заголовке `Retry-After` мы укажем, через сколько секунд можно попробовать снова.

- **Лимиты гибкие:** они ориентировочные и могут меняться, чтобы всё работало гладко;
- **Должно хватать на всё:** мы настроили их так, чтобы вам было комфортно в любых сценариях;
- **Если упёрлись в лимит:** при ошибке `429` смотрите заголовок `Retry-After` — он подскажет, через сколько секунд повторить запрос (или используйте экспоненциальный `backoff`, если хотите перестраховаться).
