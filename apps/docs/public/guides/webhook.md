
# Исходящий Webhook

Исходящие вебхуки позволяют вам получать информацию о событиях в вашем пространстве в реальном времени. Это могут быть новые сообщения, реакции, чаты, участники и тд.

Вебхук представляет собой `JSON` объект, отправляемый в момент наступления события на указанный в настройках бота `URL`, содержащий небольшое количество информации, которой достаточно для написания автоматизаций. Если требуется получить больше информации об объектах, указанных в `JSON` - вы можете воспользоваться `API` и получить полную информацию.

Каждый исходящий вебхук защищён с помощью подписи, основанной на хешировании содержимого. Подробнее об этом, а также о других методах проверки подлинности исходящего вебхука, вы можете прочитать в блоке [Безопасность](#безопасность).

## Как получать Webhook

Все настройки исходящих вебхуков находятся в чат-ботах. Создавая нового бота, вы получаете возможность указать `Webhook URL` и выбрать те события, которые вы хотите получать.

Большинство типов событий потребуют добавления бота в чаты. Именно по этим чатам и по отправленным ботом сообщениям вы будете получать события. Есть глобальные события (например, Изменение состава участников пространства), которые не требуют добавления бота в чат.

> О том, как создать бота и добавить его в чаты, вы можете прочитать в статье
  [Чат-боты через Webhook/API](https://www.pachca.com/articles/webhook)


## Новые сообщения

Данный вебхук отправляется при появлении нового сообщения в чате, где участвует бот.

Вы можете получать как все новые сообщения в чате, так и только те, которые начинаются с указанных команд. Это будет полезно, если вы не хотите получать поток событий, а вам нужно только по требованию пользователя вызвать какой-то сценарий.

#### MessageWebhookPayload

- `type` (string, **обязательный**): Тип объекта
  - **Возможные значения:**
    - `message`: Для сообщений всегда message
- `id` (integer, int32, **обязательный**): Идентификатор сообщения
- `event` (string, **обязательный**): Тип события
  - **Возможные значения:**
    - `new`: Создание
    - `update`: Обновление
    - `delete`: Удаление
- `entity_type` (string, **обязательный**): Тип сущности, к которой относится сообщение
  - **Возможные значения:**
    - `discussion`: Беседа или канал
    - `thread`: Тред
    - `user`: Пользователь
- `entity_id` (integer, int32, **обязательный**): Идентификатор сущности, к которой относится сообщение
- `content` (string, **обязательный**): Текст сообщения
- `user_id` (integer, int32, **обязательный**): Идентификатор отправителя сообщения
- `created_at` (string, date-time, **обязательный**): Дата и время создания сообщения (ISO-8601, UTC+0) в формате YYYY-MM-DDThh:mm:ss.sssZ
- `url` (string, **обязательный**): Прямая ссылка на сообщение
- `chat_id` (integer, int32, **обязательный**): Идентификатор чата, в котором находится сообщение
- `parent_message_id` (integer, int32, опциональный): Идентификатор сообщения, к которому написан ответ
- `thread` (object, опциональный): Объект с параметрами треда
  - `message_id` (integer, int32, **обязательный**): Идентификатор сообщения, к которому был создан тред
  - `message_chat_id` (integer, int32, **обязательный**): Идентификатор чата сообщения, к которому был создан тред
- `webhook_timestamp` (integer, int32, **обязательный**): Дата и время отправки вебхука (UTC+0) в формате UNIX


## Добавление и удаление реакций

Данный вебхук отправляется при добавлении или удалении реакции на сообщение в чате, где участвует бот.

#### ReactionWebhookPayload

- `type` (string, **обязательный**): Тип объекта
  - **Возможные значения:**
    - `reaction`: Для реакций всегда reaction
- `event` (string, **обязательный**): Тип события
  - **Возможные значения:**
    - `new`: Создание
    - `delete`: Удаление
- `message_id` (integer, int32, **обязательный**): Идентификатор сообщения, к которому относится реакция
- `code` (string, **обязательный**): Emoji символ реакции
- `name` (string, **обязательный**): Название реакции
- `user_id` (integer, int32, **обязательный**): Идентификатор пользователя, который добавил или удалил реакцию
- `created_at` (string, date-time, **обязательный**): Дата и время создания сообщения (ISO-8601, UTC+0) в формате YYYY-MM-DDThh:mm:ss.sssZ
- `webhook_timestamp` (integer, int32, **обязательный**): Дата и время отправки вебхука (UTC+0) в формате UNIX


## Нажатие кнопок

Данный вебхук отправляется при нажатии `Data-кнопки` в сообщении от бота. После получения этого вебхука вы можете воспользоваться методом [Редактирование сообщения](PUT /messages/{id}) и изменить/удалить кнопки у сообщения или отправить [Новое сообщение](POST /messages) как реакцию пользователю.

Подробнее о работе с кнопками в ботах вы можете прочитать в статье [Кнопки в чат-ботах](https://www.pachca.com/articles/knopki-v-chat-botah)

#### ButtonWebhookPayload

- `type` (string, **обязательный**): Тип объекта
  - **Возможные значения:**
    - `button`: Для кнопки всегда button
- `event` (string, **обязательный**): Тип события
  - **Возможные значения:**
    - `click`: Нажатие кнопки
- `message_id` (integer, int32, **обязательный**): Идентификатор сообщения, к которому относится кнопка
- `trigger_id` (string, **обязательный**): Уникальный идентификатор события. Время жизни — 3 секунды. Может быть использован, например, для открытия представления пользователю
- `data` (string, **обязательный**): Данные нажатой кнопки
- `user_id` (integer, int32, **обязательный**): Идентификатор пользователя, который нажал кнопку
- `chat_id` (integer, int32, **обязательный**): Идентификатор чата, в котором была нажата кнопка
- `webhook_timestamp` (integer, int32, **обязательный**): Дата и время отправки вебхука (UTC+0) в формате UNIX


## Изменение состава участников чатов

Данный вебхук отправляется при изменении состава участников чатов, где состоит бот, и в тредах этих чатов.

#### ChatMemberWebhookPayload

- `type` (string, **обязательный**): Тип объекта
  - **Возможные значения:**
    - `chat_member`: Для участника чата всегда chat_member
- `event` (string, **обязательный**): Тип события
  - **Возможные значения:**
    - `add`: Добавление
    - `remove`: Удаление
- `chat_id` (integer, int32, **обязательный**): Идентификатор чата, в котором изменился состав участников
- `thread_id` (integer, int32, опциональный): Идентификатор треда
- `user_ids` (array[integer], **обязательный**): Массив идентификаторов пользователей, с которыми произошло событие
- `created_at` (string, date-time, **обязательный**): Дата и время события (ISO-8601, UTC+0) в формате YYYY-MM-DDThh:mm:ss.sssZ
- `webhook_timestamp` (integer, int32, **обязательный**): Дата и время отправки вебхука (UTC+0) в формате UNIX


## Изменение состава участников пространства

Данный вебхук отправляется при изменении состава участников пространства, включая изменение состояния участников (смотреть на значение поля event).

#### CompanyMemberWebhookPayload

- `type` (string, **обязательный**): Тип объекта
  - **Возможные значения:**
    - `company_member`: Для участника пространства всегда company_member
- `event` (string, **обязательный**): Тип события
  - **Возможные значения:**
    - `invite`: Приглашение
    - `confirm`: Подтверждение
    - `update`: Обновление
    - `suspend`: Приостановка
    - `activate`: Активация
    - `delete`: Удаление
- `user_ids` (array[integer], **обязательный**): Массив идентификаторов пользователей, с которыми произошло событие
- `created_at` (string, date-time, **обязательный**): Дата и время события (ISO-8601, UTC+0) в формате YYYY-MM-DDThh:mm:ss.sssZ
- `webhook_timestamp` (integer, int32, **обязательный**): Дата и время отправки вебхука (UTC+0) в формате UNIX


## Разворачивание ссылок

Данный вебхук отправляется при появлении ссылки на один из доменов, указанных в настройках Unfurl-бота. Для получения таких событий необходимо создать специального Unfurl-бота. После получения этого вебхука вы можете воспользоваться методом [Unfurl (разворачивание ссылок)](POST /messages/{id}/link_previews) и создать предпросмотр ссылки в сообщении.

Подробнее о разворачивании ссылок вы можете прочитать в статье [Unfurling ссылок в Пачке](https://www.pachca.com/articles/unfurling-ssylok-v-pachce)

#### LinkSharedWebhookPayload

- `type` (string, **обязательный**): Тип объекта
  - **Возможные значения:**
    - `message`: Для разворачивания ссылок всегда message
- `event` (string, **обязательный**): Тип события
  - **Возможные значения:**
    - `link_shared`: Обнаружена ссылка на отслеживаемый домен
- `chat_id` (integer, int32, **обязательный**): Идентификатор чата, в котором обнаружена ссылка
- `message_id` (integer, int32, **обязательный**): Идентификатор сообщения, содержащего ссылку
- `links` (array[object], **обязательный**): Массив обнаруженных ссылок на отслеживаемые домены
  - `url` (string, **обязательный**): URL ссылки
  - `domain` (string, **обязательный**): Домен ссылки
- `created_at` (string, date-time, **обязательный**): Дата и время создания сообщения (ISO-8601, UTC+0) в формате YYYY-MM-DDThh:mm:ss.sssZ
- `webhook_timestamp` (integer, int32, **обязательный**): Дата и время отправки вебхука (UTC+0) в формате UNIX


## Безопасность

Каждый исходящий вебхук защищён с помощью подписи, основанной на хешировании содержимого. Подпись `HMAC` с использованием алгоритма `SHA256` вычисляется из тела запроса и передаётся в заголовке `Pachca-Signature`.

В теле вебхука также содержится поле `webhook_timestamp` — метка времени в формате UNIX, указывающая момент отправки вебхука. Рекомендуется проверять, что это значение находится в пределах одной минуты от времени получения запроса, чтобы предотвратить атаки повторной отправки (replay attacks).

**Пример исходящего вебхука (новое сообщение)**

```http
POST https://yourweb.site/read HTTP/1.1
host: yourweb.site
content-Type: application/json
pachca-signature: a805d3470c263f4628cafc4ed66235d8fe2229891d1fcf4e400331adff5d8e5a
user-agent: Faraday v2.12.2
content-length: 358

{
    "event": "new",
    "type": "message",
    "webhook_timestamp": 1744618734,
    "chat_id": 918264,
    "content": "Клиент просит поправить шапку, подробности в документе",
    "user_id": 134412,
    "id": 56431,
    "created_at": "2025-04-14T08:18:54.000Z",
    "parent_message_id": null,
    "entity_type": "discussion",
    "entity_id": 918264,
    "thread": null,
    "url": "https://app.pachca.com/chats/124511?message=56431"
}
```


  ### Шаг 1. Проверьте подпись

Для проверки подписи необходимо вычислить её самостоятельно, используя секрет вебхука `Signing secret`, который доступен в настройках бота во вкладке «Исходящий webhook». Рекомендуется использовать сырой (raw) контент тела запроса для вычисления хеша, так как при JSON-парсинге содержимое может быть изменено.

    **Вычисление и сравнение подписи**

```javascript
// WEBHOOK_SECRET - значение поля Signing secret во вкладке «Исходящий webhook» в настройках бота

const signature = crypto.createHmac("sha256", WEBHOOK_SECRET).update(rawBody).digest("hex");
if (signature !== request.headers['pachca-signature']) {
    throw "Invalid signature"
}
```


  ### Шаг 2. Валидируйте IP-адрес отправителя

Кроме проверки подписи, также рекомендуется валидировать IP-адреса отправителя.

    IP-адрес Пачки: `37.200.70.177`


