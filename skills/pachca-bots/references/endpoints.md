# pachca-bots — Справочник эндпоинтов

## Редактирование бота

**PUT** `/bots/{id}`

> Скоуп: `bots:write`

Редактирование бота

Метод для редактирования бота.

Для редактирования бота вам необходимо знать его `user_id` и указать его в `URL` запроса. Все редактируемые параметры бота указываются в теле запроса. Узнать `user_id` бота можно в настройках бота во вкладке «API».

Вы не можете редактировать бота, настройки которого вам недоступны (поле «Кто может редактировать настройки бота» находится во вкладке «Основное» в настройках бота).

**Параметры:**

- `id` (path, integer, **обязательный**): Идентификатор бота

**Тело запроса** (`application/json`):

- `bot` (object, **обязательный**): Собранный объект параметров редактируемого бота
  - `webhook` (object, **обязательный**): Объект параметров вебхука
    - `outgoing_url` (string, **обязательный**): URL исходящего вебхука

**Пример:**

```bash
curl -X PUT "https://api.pachca.com/api/shared/v1/bots/12345" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
  "bot": {
    "webhook": {
      "outgoing_url": "https://www.website.com/tasks/new"
    }
  }
}'
```

**Ответ:**

- `data` (object, **обязательный**): Ответ с данными бота
  - `id` (integer, **обязательный**): Идентификатор бота
  - `webhook` (object, **обязательный**): Объект параметров вебхука
    - `outgoing_url` (string, **обязательный**): URL исходящего вебхука

---

## Unfurl (разворачивание ссылок)

**POST** `/messages/{id}/link_previews`

> Скоуп: `link_previews:write`

Unfurl (разворачивание ссылок)

Метод для создания предпросмотров ссылок в сообщениях.

Для создания предпросмотров ссылок вам необходимо знать `id` сообщения и указать его в `URL` запроса.

Изображения вы можете предоставить как публичной ссылкой (параметром `image_url`), так и с помощью прямой загрузки файла на наш сервер (параметром `image`) через метод `Загрузка файлов`. Если вы указали оба параметра сразу, то `image` является более приоритетным.

Если среди присланных `URL`-ключей будет выявлена ошибка (такого `URL` нет в сообщении или боту не прописан в настройках домен указанного `URL`), то запрос не будет выполнен (не будет создано ни одного предпросмотра).

На данный момент поддерживается отображение только первого созданного предпросмотра ссылки к сообщению. Все присланные вами `link_previews` будут сохранены и появятся в сообщениях в ближайших обновлениях.

**Параметры:**

- `id` (path, integer, **обязательный**): Идентификатор сообщения

**Тело запроса** (`application/json`):

- `link_previews` (object, **обязательный**): `JSON` карта предпросмотров ссылок, где каждый ключ — `URL`, который был получен в исходящем вебхуке о новом сообщении.

**Пример:**

```bash
curl "https://api.pachca.com/api/shared/v1/messages/12345/link_previews" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
  "link_previews": {
    "key": {
      "title": "Статья: Отправка файлов",
      "description": "Пример отправки файлов на удаленный сервер",
      "image_url": "https://website.com/img/landing.png",
      "image": {
        "key": "attaches/files/93746/e354fd79-9jh6-f2hd-fj83-709dae24c763/${filename}",
        "name": "files-to-server.jpg",
        "size": 695604
      }
    }
  }
}'
```

---

## История событий

**GET** `/webhooks/events`

> Скоуп: `webhooks:events:read`

История событий

Метод для получения истории последних событий бота. Данный метод будет полезен, если вы не можете получать события в реальном времени на ваш `URL`, но вам требуется обрабатывать все события, на которые вы подписались.

История событий сохраняется только при активном пункте «Сохранять историю событий» во вкладке «Исходящий webhook» настроек бота. При этом указывать «Webhook `URL`» не требуется.

Для получения истории событий конкретного бота вам необходимо знать его `access_token` и использовать его при запросе. Каждое событие представляет `JSON` объект вебхука.

**Параметры:**

- `limit` (query, integer, опциональный): Количество возвращаемых сущностей за один запрос
- `cursor` (query, string, опциональный): Курсор для пагинации (из meta.paginate.next_page)

**Пример:**

```bash
curl "https://api.pachca.com/api/shared/v1/webhooks/events?limit=50&cursor=string" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**Ответ:**

- `data` (array[object], **обязательный**): 
  - `id` (string, **обязательный**): Идентификатор события
  - `event_type` (string, **обязательный**): Тип события
  - `payload` (object, **обязательный**): Объект вебхука
  - `created_at` (string, **обязательный**): Дата и время создания события (ISO-8601, UTC+0) в формате YYYY-MM-DDThh:mm:ss.sssZ
- `meta` (object, опциональный): Метаданные пагинации
  - `paginate` (object, опциональный): Вспомогательная информация
    - `next_page` (string, опциональный): Курсор пагинации следующей страницы

---

## Удаление события

**DELETE** `/webhooks/events/{id}`

> Скоуп: `webhooks:events:delete`

Удаление события

Данный метод доступен для работы только с `access_token` бота

Метод для удаления события из истории событий бота.

Для удаления события вам необходимо знать `access_token` бота, которому принадлежит событие, и `id` события.

**Параметры:**

- `id` (path, string, **обязательный**): Идентификатор события

**Пример:**

```bash
curl -X DELETE "https://api.pachca.com/api/shared/v1/webhooks/events/string" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

---
